<!doctype html>
<html>
  <head>
    <title>ExoPlaneteer - My Planets</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta charset="utf-8">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbars/">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Audiowide&family=Courier+Prime&family=Megrim&family=Orbitron&display=swap"
      rel="stylesheet">

    <!-- Jerk Query -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
	    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <!-- Web3 -->
    <script type="module">
    </script>
  </head>

  <body style="width: 100%; height: auto; margin: 0 auto; background-color: black;">
    <span id="prev" style="position: fixed; top: 10%; left:  2%; z-index: 2; font-size: 10vw;">&lt</span>
    <span id="next" style="position: fixed; top: 10%; right: 2%; z-index: 2; font-size: 10vw;">&gt</span>

    <div class="container-fluid">
      <div class="row">
	<nav id="navheader" class="navbar navbar-expand-lg navbar-dark bg-transparent" style="position: relative; left: 0, top: 0; background: transparent; border: 0; z-index: 10;">
	</nav>
	<script src="js/headermenu.js" type="module"></script>
      </div>
      <div class="row">
	<span id="headname" style="position: fixed; top: 20%; left:  0%; z-index: 1; font-size: 4vw;"
	      class="rot-neg-90"></span>
	<div id="planetDisplay"
	     style="border-radius: 2vw; width: 100%; background-color:black; background-repeat: no-repeat;">
	  <video id="planetVideo" autoplay loop muted preload="metadata"
		 style="width: 100%; border-radius: 2vw;"></video>
	</div>
      </div>
      <div id="title" class="row" style=>
	<hr />
	<div style="font-size: 4vw; text-align: center;" id="official"></div>
	<div style="text-align: center; font-size: 2vw;">
	  Common Name: <span style="font-size: 4vw; text-align: center;" id="common">
	  </span>
	</div>
	<div style="font-size: 2vw; text-align: center;" id="planetLevelDiv">Level:
	  <span style="font-size: 3vw;" id="planetLevel"></span>
	</div>
	<div style="margin: 2vw; text-align: center; font-size: 2vw;">Motto:
	  <span style="font-size: 2.5vw; text-align: center; font-style: italic;" id="motto">
	  </span>
	</div>
	<hr />
	<div class="row" style="text-align: center; align-items: center; font-size: 2vw;">
	  <div>
	    Galactic Catalog#:<span name="identity" id="identity1" style="font-size: 2vw"></span>
	  </div>
	  <div>Population:
	    <span id="population" style="font-size: 2vw">0</span>
	  </div>
	  <div>Last Update:
	    <span id="updatedAt" style="font-size: 2vw"></span>
	  </div>
	  <div>Tritanium44 Production:
	    <span id="t44production" style="font-size: 2vw">1</span>/day
	  </div>
	  <div>Tritanium44 Reserves:
	    <span id="tritanium44" style="font-size: 2vw">0</span>
	  </div>
	  <div>Transfer T44: <input type="number" value="0" maxlength="10" onchange="showtransfer(this)"
				    style="text-align: right; width: 20vw;">
	    <span id="transfer" style="font-size: 3vw"></span><br>
	    <a style="font-size: 2vw; color: red;" href="https://metamask.io/download/">You must login with a crypto wallet to be able to extract Tritanium-44 crypto</a>
	  </div>
	</div>
	<p></p>
	<hr />
	<div id="planetevents" class="row section">
	  <h1>Latest Events</h1>
	  <div id="eventlist" class="eventlist">
	  </div>
	  <hr>
	  <div id="civilization" class="row section">
	    <h1>Civilization Stats</h1>
	    <div id="civstatstable" class="statstable col-sm-8 data">
	    </div>
	  </div>
	  <hr>
	  <div id="basestats" class="row section">
	    <h1>Fundamental Statistics and Natural Resources</h1>
	    <div id="basestatstable" class="statstable col-sm-8 data">
	    </div>
	  </div>
	</div>
      </div>
    </div>
    <script type="module">
      import * as utils from './js/utils.mjs';
      import {exogeny} from './js/exogeny.mjs';
      import {web3utils} from './js/web3.mjs';
      
      var Params = {};
      parseQuery(window.location.search, Params); // why not return Params? wanted to be able to add to already existing Params

      var Planets = [];
      var currentPlanet = 0;
      var sector = utils.getCookie("sector") || "vortexis";
      
      function arrow(index) {
	  //Update();
      }

      document.onclick = function clickNavigate(e) {
	  const hotzone = window.innerWidth / 10;
	  if (e.pageX < hotzone) {
	      --currentPlanet;
	      Update();
	  }

	  if (e.pageX > (window.innerWidth - hotzone)) {
	      ++currentPlanet;
	      Update();
	  }
      }

      function parseQuery(query, destination) {
	  var rval = destination || {};
	  query.replace(/[?&]([^=]+)=([^&]*)/g, function (all, key, value) {
	      rval[key] = value;
	  });
	  return rval;
      }

      function showtransfer(element) {
	  if (element.value < 0)
	      transfer.innerText = "(collect T44 to Wallet)";
	  else if (element.value > 0)
	      transfer.innerText = "(invest T44 from Wallet)";
	  else
	      transfer.innerText = "                        ";
      }

      function fromRoman(roman) {
	  const map = {
	      "Prime": 1,
	      "II": 2,
	      "III": 3,
	      "IV": 4,
	      "V": 5,
	      "VI": 6,
	      "VII": 7,
	      "VIII": 8,
	      "IX": 9,
	      "X": 10,
	      "XI": 11,
	      "XII": 12,
	      "XIII": 13,
	      "XIV": 14,
	      "XV": 15
	  };
	  return map[roman] || "";
      }
      
      async function Move(targetCollection, targetId, targetElement, command, parameters, displayElement) {
	  const NFT = Planets[currentPlanet];

	  const userId = Moralis.User.current().id;
	  const identity = `${userId}_${NFT.traits.galactic_catalog}_${targetId}_${targetElement}`;

	  const contents = { "identity": identity, "sourceUserId": userId, "sourceUser": Moralis.User.current(), "sourceCivilization": NFT.traits.galactic_catalog, "targetCollection": targetCollection, "targetId": targetId, "targetElement": targetElement, "command": command, "parameters": parameters };
	  console.log(`Move ${JSON.stringify(contents)}`);

	  const query = new Moralis.Query("Move");
	  query.equalTo("identity", identity) // did we already make this move for this period, overwrite it
	  var thing = await query.first();

	  if (thing) {
	      thing.set(contents);
	      console.log(`Update ${JSON.stringify(thing)}`);
	  } else {
	      thing = new Moralis.Object("Move", contents);
	      console.log(`Write New ${JSON.stringify(thing)}`);
	  }

	  result = await thing.save()
	  console.log(`Wrote ${JSON.stringify(thing)}`);
	  if (displayElement)
	      displayElement.innerText = `${parameters.value}`; // show user that he registered an intervention
	  alert("Your move has been registered and will take effect at the top of the hour. You can change it at any time until then");
      }

      function dimReturn(units, perUnitCost) {  // diminishing returns, parabolic cost value ^ factor
	  let cost = Math.pow(parseInt(units) * perUnitCost, 1.5);
	  return `${units}% will cost ${Math.ceil(cost)} T44`;
      }

      function effectsString(affected) {
	  let effectStr = "";
	  let max = 0;
	  for (let key in affected) {
	      let amount = affected[key];
	      if (amount.match(/^-/))
		  effectStr += `<b>${key}</b> lowered as much as <b>${amount}</b><br>`;
	      else if (amount.match(/^[+0-9]/))
		  effectStr += `<b>${key}</b> raised as much as <b>${amount}</b><br>`;
	      else
		  effectStr += `<b>${key}</b> could change to <b>${amount}</b><br>`;

	  }
	  return effectStr;
      }
      
      async function eventAlert(message, sound) {
	  if (!sound)
	      sound = getCookie("notification");
	  if (sound == "none")
	      return;
	  //if (!document.hidden) // don't alert if user is already looking
	  //return;
	  setTimeout(function() {
	      let answer = window.confirm(message+"\nPress cancel to turn off these messages.");
	      if (!answer)
		  setCookie("notification", "none");
	  }, 2000);
	  let soundFile = `sounds/${sound}.mp3`;
	  new Audio(soundFile).play();
      }
      
      async function Update(NFT) {
	  if (!NFT)
	      NFT = Planets[currentPlanet];
	  const planetVideo = document.getElementById('planetVideo');

	  const pvideo = NFT.animation_url;
	  const pimage = NFT.image;
	  //planetVideo.poster = pimage
	  planetVideo.src = pvideo;

	  var html = `<table class="statstable">\n`;
	  html += `<th><td>Official Designation</td><td>${NFT.official_designation}</td></th>\n`;
	  html += exogeny.FormatPlanetData(NFT, '<tr name="{1}"><td name="{1}">{1}</td><td id="{1}">{2}</td></tr>\n');
	  html += "</table>";
	  var info = document.getElementById("basestatstable");
	  info.innerHTML = html;
      }
      
      var wallet = await web3utils.WalletAddress();
      var contractAddress = "0x9c46ce465e14fc0c172e6daa836431180f5b4ba2";
      web3utils.GetNFTs(wallet, contractAddress).then(
	  (nfts)=>{ Planets = nfts; Update(nfts[0]) }
      ).catch(console.error);

      </script>
  </body>
</head>
