<!doctype html>
<html>
  <head>
    <title>ExoPlaneteer - My Planets</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta charset="utf-8">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbars/">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Audiowide&family=Courier+Prime&family=Megrim&family=Orbitron&display=swap"
      rel="stylesheet">
    <link rel="stylesheet" href="css/game.css">

    <!-- Jerk Query -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
	    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </head>

  <body style="width: 100%; height: auto; margin: 0 auto; background-color: black;">
    <div class="container-fluid">
      <div class="row">
	<div style="display: flex; height: 100vh; position: relative; 
		    border-radius: 2vw; justify-content: center; align-items: center; 
		    background-image: images/stars.jpg; background-size: cover; background-repeat: repeat; overflow: hidden;">
	  
	  <span id="prev" style="position: fixed; top: 40%; left:  2%; z-index: 2; color: gray; font-size: 10vw;">&lt</span>
	  <span id="next" style="position: fixed; top: 40%; right: 2%; z-index: 2; color: gray; font-size: 10vw;">&gt</span>
	
	  <div id="planetDisplay" style="position: relative; width: 100%; max-width: 1400px; height: 96%; padding: 0; margin: 0;display: flex; color: white; font-size: 2vw;
					 border-radius: 2vw; justify-content: center; overflow: hidden;">
	  
	       <video id="planetVideo" autoplay loop muted preload="metadata" style="z-index: -10; height: 100%; border-radius: 2vw;"></video>
	       
	       <div id="upperLeft" class="videolabel" style="position: absolute; top:1%; left: 4%;">
	       </div>

	       <img id="lifeformImage" style="pointerEvents: auto; visibility: hidden; display: none; position: absolute; left: 0; top: 0; width: 100%; height: 100%; zIndex: 20;">
	       <div id="upperRight" style="position: absolute; height: 12%; width: 12%; top: 2%; right: 2%";>
		 <img id="lifeformIcon" style="height: 100%;">
	       </div>

	       <div id="lowerLeft" class="videolabel" style="position: absolute; bottom: 2%; left: 4%;">
	       </div>

	       <div id="lowerRight" class="videolabel"  style="position: absolute; bottom: 2%; right: 4%;">
	       </div>
	       
	  </div>
	</div>
	<p></p>
	<hr />
	<div id="planetdata" class="row section info" >
	  <span class="statsheader">Latest Events</span>
	  <div id="eventlist" class="eventlist">
	  </div>
	  <hr>
	  <div id="civilization" class="row section">
	    <span class="statsheader">Civilization Stats</span>
	    <div id="civstatstable" class="statstable col-sm-8 data">
	    </div>
	  </div>
	  <hr>
	  <span class="statsheader" id="fundamentals"></span>
	  <div id="basestats" class="row section tablestats" hx-get="stats_resources?hx-swap=innerHTML">
	    <div id="basestatstable" class="statstable">
	    </div>
	  </div>
	</div>
      </div>
    </div>
    <script type="module">
      import * as utils from './js/utils.mjs';
      import {exogeny} from './js/exogeny.mjs';
      import {web3utils} from './js/web3.mjs';

      var Config = {};
      
      var Params = {};
      parseQuery(window.location.search, Params); // why not return Params? wanted to be able to add to already existing Params

      var Planets = [];
      var currentPlanet = 0;
      var sector = utils.getCookie("sector") || "vortexis";
      
      function arrow(index) {
	  //Update();
      }

      document.onclick = function clickNavigate(e) {
	  const hotzone = window.innerWidth / 10;
	  if (e.pageX < hotzone) {
	      --currentPlanet;
	      Update();
	  }

	  if (e.pageX > (window.innerWidth - hotzone)) {
	      ++currentPlanet;
	      Update();
	  }
      }

      function parseQuery(query, destination) {
	  var rval = destination || {};
	  query.replace(/[?&]([^=]+)=([^&]*)/g, function (all, key, value) {
	      rval[key] = value;
	  });
	  return rval;
      }

      function showtransfer(element) {
	  if (element.value < 0)
	      transfer.innerText = "(collect T44 to Wallet)";
	  else if (element.value > 0)
	      transfer.innerText = "(invest T44 from Wallet)";
	  else
	      transfer.innerText = "                        ";
      }
      
      async function Move(targetCollection, targetId, targetElement, command, parameters, displayElement) {
	  const NFT = Planets[currentPlanet];

	  const userId = Moralis.User.current().id;
	  const identity = `${userId}_${NFT.traits.galactic_catalog}_${targetId}_${targetElement}`;

	  const contents = { "identity": identity, "sourceUserId": userId, "sourceUser": Moralis.User.current(), "sourceCivilization": NFT.traits.galactic_catalog, "targetCollection": targetCollection, "targetId": targetId, "targetElement": targetElement, "command": command, "parameters": parameters };
	  console.log(`Move ${JSON.stringify(contents)}`);

	  const query = new Moralis.Query("Move");
	  query.equalTo("identity", identity) // did we already make this move for this period, overwrite it
	  var thing = await query.first();

	  if (thing) {
	      thing.set(contents);
	      console.log(`Update ${JSON.stringify(thing)}`);
	  } else {
	      thing = new Moralis.Object("Move", contents);
	      console.log(`Write New ${JSON.stringify(thing)}`);
	  }

	  result = await thing.save()
	  console.log(`Wrote ${JSON.stringify(thing)}`);
	  if (displayElement)
	      displayElement.innerText = `${parameters.value}`; // show user that he registered an intervention
	  alert("Your move has been registered and will take effect at the top of the hour. You can change it at any time until then");
      }

      function dimReturn(units, perUnitCost) {  // diminishing returns, parabolic cost value ^ factor
	  let cost = Math.pow(parseInt(units) * perUnitCost, 1.5);
	  return `${units}% will cost ${Math.ceil(cost)} T44`;
      }

      function effectsString(affected) {
	  let effectStr = "";
	  let max = 0;
	  for (let key in affected) {
	      let amount = affected[key];
	      if (amount.match(/^-/))
		  effectStr += `<b>${key}</b> lowered as much as <b>${amount}</b><br>`;
	      else if (amount.match(/^[+0-9]/))
		  effectStr += `<b>${key}</b> raised as much as <b>${amount}</b><br>`;
	      else
		  effectStr += `<b>${key}</b> could change to <b>${amount}</b><br>`;

	  }
	  return effectStr;
      }
      
      async function eventAlert(message, sound) {
	  if (!sound)
	      sound = getCookie("notification");
	  if (sound == "none")
	      return;
	  //if (!document.hidden) // don't alert if user is already looking
	  //return;
	  setTimeout(function() {
	      let answer = window.confirm(message+"\nPress cancel to turn off these messages.");
	      if (!answer)
		  setCookie("notification", "none");
	  }, 2000);
	  let soundFile = `sounds/${sound}.mp3`;
	  new Audio(soundFile).play();
      }
      
      async function Update(planet) {
	  if (!planet)
	      planet = Planets[currentPlanet];
	  const planetVideo = document.getElementById('planetVideo');

	  if (!planet.attribmap) {
	      planet.attribmap = {};
	      planet.attributes.forEach(attrib =>{
		  planet.attribmap[attrib.trait_type] = attrib.value;
	      });
	  }
	  
	  const pvideo = planet.animation_url;
	  const pimage = planet.image;
	  //planetVideo.poster = pimage
	  planetVideo.src = pvideo;
	  planetVideo.currentTime = 10;
	  
	  document.getElementById("upperLeft").innerHTML = `<img style="width: 5vw;" src="image/resources.png"><br>&nbsp;<span style="font-weight: bold;">${planet.attribmap.natural_resources_rating}</span>`;
	  
	  lifeformImage.src = planet.image;
	  
	  lifeformIcon.src = `image/${planet.attribmap['indigenous_lifeform']}.png`;
	  lifeformIcon.title = `${planet.attribmap['indigenous_lifeform']}`;
	  
	  $('lifeformIcon').lifeformImage = lifeformImage;
	  lifeformIcon.addEventListener('mousedown', function() {
	      utils.show(lifeformImage);
	  });
	  lifeformIcon.addEventListener('mouseup', function() {
	      utils.hide(lifeformImage);
	  });
	  
	  lowerLeft.innerHTML = `<span>${utils.titleize(planet.attribmap.parent_star)}</span>`;

	  lowerRight.innerHTML = `<span title="${utils.fromRoman(planet.attribmap.orbital_position)}">${utils.toRoman(planet.attribmap.orbital_position)}<span>`;

	  fundamentals.innerHTML = `<span>Fundamental Statistics for ${planet.name}</span>`;
	  
	  let data = exogeny.FormatPlanetData(planet, `<tr><td class="statlabel">{1}</td><td class="statvalue">{2}</td></tr>\n`);
	  let html = '<table class="statstable">\n';
	  html += data;
	  html += '</table>\n';
	  basestatstable.innerHTML = html;
      }
      
      fetch('configs/galaxy.json', { headers: {'Cache-Control':'no-cache'} })
    		.then((response) => response.json())
    		.then((data) => Config = data)
    		.catch(console.log)
      var wallet = await web3utils.WalletAddress();
      var contractAddress = "0x9c46ce465e14fc0c172e6daa836431180f5b4ba2";
      web3utils.GetNFTs(wallet, contractAddress).then(
	  (nfts)=>{ Planets = nfts; Update(nfts[0]) }
      ).catch(console.error);

      </script>
  </body>
</head>
