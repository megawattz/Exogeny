<!doctype html>
<html>
  <head>
    <title>ExoPlaneteer - My Planets</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta charset="utf-8">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbars/">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Audiowide&family=Courier+Prime&family=Megrim&family=Orbitron&display=swap"
      rel="stylesheet">

    <!-- Jerk Query -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
	    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <!-- Web3 -->
    <script type="module">
    </script>
  </head>

  <body style="width: 100%; height: auto; margin: 0 auto; background-color: black;">
    <span id="prev" style="position: fixed; top: 10%; left:  2%; z-index: 2; font-size: 10vw;">&lt</span>
    <span id="next" style="position: fixed; top: 10%; right: 2%; z-index: 2; font-size: 10vw;">&gt</span>

    <div class="container-fluid">
      <div class="row">
	<nav id="navheader" class="navbar navbar-expand-lg navbar-dark bg-transparent" style="position: relative; left: 0, top: 0; background: transparent; border: 0; z-index: 10;">
	</nav>
	<script src="js/headermenu.js" type="module"></script>
      </div>
      <div class="row">
	<span id="headname" style="position: fixed; top: 20%; left:  0%; z-index: 1; font-size: 4vw;"
	      class="rot-neg-90"></span>
	<div id="planetDisplay"
	     style="border-radius: 2vw; width: 100%; background-color:black; background-repeat: no-repeat;">
	  <video id="planetVideo" autoplay loop muted preload="metadata"
		 style="width: 100%; border-radius: 2vw;"></video>
	</div>
      </div>
      <div id="title" class="row" style=>
	<hr />
	<div style="font-size: 4vw; text-align: center;" id="official"></div>
	<div style="text-align: center; font-size: 2vw;">
	  Common Name: <span style="font-size: 4vw; text-align: center;" id="common">
	  </span>
	</div>
	<div style="font-size: 2vw; text-align: center;" id="planetLevelDiv">Level:
	  <span style="font-size: 3vw;" id="planetLevel"></span>
	</div>
	<div style="margin: 2vw; text-align: center; font-size: 2vw;">Motto:
	  <span style="font-size: 2.5vw; text-align: center; font-style: italic;" id="motto">
	  </span>
	</div>
	<hr />
	<div class="row" style="text-align: center; align-items: center; font-size: 2vw;">
	  <div>
	    Galactic Catalog#:<span name="identity" id="identity1" style="font-size: 2vw"></span>
	  </div>
	  <div>Population:
	    <span id="population" style="font-size: 2vw">0</span>
	  </div>
	  <div>Last Update:
	    <span id="updatedAt" style="font-size: 2vw"></span>
	  </div>
	  <div>Tritanium44 Production:
	    <span id="t44production" style="font-size: 2vw">1</span>/day
	  </div>
	  <div>Tritanium44 Reserves:
	    <span id="tritanium44" style="font-size: 2vw">0</span>
	  </div>
	  <div>Transfer T44: <input type="number" value="0" maxlength="10" onchange="showtransfer(this)"
				    style="text-align: right; width: 20vw;">
	    <span id="transfer" style="font-size: 3vw"></span><br>
	    <a style="font-size: 2vw; color: red;" href="https://metamask.io/download/">You must login with a crypto wallet to be able to extract Tritanium-44 crypto</a>
	  </div>
	</div>
	<p></p>
	<hr />
	<div id="planetevents" class="row section">
	  <h1>Latest Events</h1>
	  <div id="eventlist" class="eventlist">
	  </div>
	  <hr>
	  <div id="civilization" class="row section">
	    <h1>Civilization Stats</h1>
	    <div id="civstatstable" class="statstable col-sm-8 data">
	    </div>
	  </div>
	  <hr>
	  <div id="basestats" class="row section">
	    <h1>Fundamental Statistics and Natural Resources</h1>
	    <div id="basestatstable" class="statstable col-sm-8 data">
	    </div>
	  </div>
	</div>
	<script type="module">
	  import * as utils from './js/utils.mjs';
	  import {web3utils} from './js/web3.mjs';

	  var Params = {};
	  parseQuery(window.location.search, Params); // why not return Params? wanted to be able to add to already existing Params

	  var userNFTs = [];
	  var currentNFT = 0;

	  function arrow(index) {
	      //Update();
	  }

	  document.onclick = function clickNavigate(e) {
	      const hotzone = window.innerWidth / 10;
	      if (e.pageX < hotzone) {
		  --currentNFT;
		  Update();
	      }

	      if (e.pageX > (window.innerWidth - hotzone)) {
		  ++currentNFT;
		  Update();
	      }
	  }

	  async function MailUserGetNFTs(emailUser) {
	      let token_address = emailUser.get("freeNFTcontract");
	      let token_id = emailUser.get("freeNFTtokenIndex");

	      let nft = await Moralis.Web3API.token.getTokenIdMetadata({
		  chain: "mumbai",
		  address: token_address,
		  token_id: token_id
	      });

	      return { result: [nft] };
	  }

	  var wallet = await web3utils.WalletAddress();
	  var contractAddress = "0x9c46ce465e14fc0c172e6daa836431180f5b4ba2";
	  
	  async function LoadNFTarray(intoArray) {
	      intoArray = await web3utils.GetNFTs(wallet, contractAddress);
	      return userNFTs;
	  }

	  function parseQuery(query, destination) {
	      var rval = destination || {};
	      query.replace(/[?&]([^=]+)=([^&]*)/g, function (all, key, value) {
		  rval[key] = value;
	      });
	      return rval;
	  }

	  function showtransfer(element) {
	      if (element.value < 0)
		  transfer.innerText = "(collect T44 to Wallet)";
	      else if (element.value > 0)
		  transfer.innerText = "(invest T44 from Wallet)";
	      else
		  transfer.innerText = "                        ";
	  }

	  function fromRoman(roman) {
	      const map = {
		  "Prime": 1,
		  "II": 2,
		  "III": 3,
		  "IV": 4,
		  "V": 5,
		  "VI": 6,
		  "VII": 7,
		  "VIII": 8,
		  "IX": 9,
		  "X": 10,
		  "XI": 11,
		  "XII": 12,
		  "XIII": 13,
		  "XIV": 14,
		  "XV": 15
	      };
	      return map[roman] || "";
	  }

	  function ordinal(place) {
	      const map = ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th", "9th", "10th", "11th", "12th", "13th", "14th", "15th"];
	      return map[place] || "";
	  }

	  async function Move(targetCollection, targetId, targetElement, command, parameters, displayElement) {
	      const NFT = userNFTs[currentNFT];

	      const userId = Moralis.User.current().id;
	      const identity = `${userId}_${NFT.traits.galactic_catalog}_${targetId}_${targetElement}`;

	      const contents = { "identity": identity, "sourceUserId": userId, "sourceUser": Moralis.User.current(), "sourceCivilization": NFT.traits.galactic_catalog, "targetCollection": targetCollection, "targetId": targetId, "targetElement": targetElement, "command": command, "parameters": parameters };
	      console.log(`Move ${JSON.stringify(contents)}`);

	      const query = new Moralis.Query("Move");
	      query.equalTo("identity", identity) // did we already make this move for this period, overwrite it
	      var thing = await query.first();

	      if (thing) {
		  thing.set(contents);
		  console.log(`Update ${JSON.stringify(thing)}`);
	      } else {
		  thing = new Moralis.Object("Move", contents);
		  console.log(`Write New ${JSON.stringify(thing)}`);
	      }

	      result = await thing.save()
	      console.log(`Wrote ${JSON.stringify(thing)}`);
	      if (displayElement)
		  displayElement.innerText = `${parameters.value}`; // show user that he registered an intervention
	      alert("Your move has been registered and will take effect at the top of the hour. You can change it at any time until then");
	  }

	  function dimReturn(units, perUnitCost) {  // diminishing returns, parabolic cost value ^ factor
	      let cost = Math.pow(parseInt(units) * perUnitCost, 1.5);
	      return `${units}% will cost ${Math.ceil(cost)} T44`;
	  }

	  function effectsString(affected) {
	      let effectStr = "";
	      let max = 0;
	      for (let key in affected) {
		  let amount = affected[key];
		  if (amount.match(/^-/))
		      effectStr += `<b>${key}</b> lowered as much as <b>${amount}</b><br>`;
		  else if (amount.match(/^[+0-9]/))
		      effectStr += `<b>${key}</b> raised as much as <b>${amount}</b><br>`;
		  else
		      effectStr += `<b>${key}</b> could change to <b>${amount}</b><br>`;

	      }
	      return effectStr;
	  }
	  
	  async function eventAlert(message, sound) {
	      if (!sound)
		  sound = getCookie("notification");
	      if (sound == "none")
		  return;
	      //if (!document.hidden) // don't alert if user is already looking
	      //return;
	      setTimeout(function() {
		  let answer = window.confirm(message+"\nPress cancel to turn off these messages.");
		  if (!answer)
		      setCookie("notification", "none");
	      }, 2000);
	      let soundFile = `sounds/${sound}.mp3`;
	      new Audio(soundFile).play();
	  }
	  
	  async function Update(NFT) {
	      if (!NFT)
		  NFT = userNFTs[currentNFT];
 	      const ipfsgate = "https://ipfs.moralis.io:2053/ipfs/";
	      NFT.meta = JSON.parse(NFT.metadata);
	      const planetVideo = document.getElementById('planetVideo');
	      const pvideo = NFT.meta.animation_url.replace("ipfs://", ipfsgate)
	      const pimage = NFT.meta.image.replace("ipfs://", ipfsgate);
	      planetVideo.poster = pimage
	      planetVideo.src = pvideo;
	      NFT.traits = {};
	      var Traits = NFT.traits;
	      for (idx in NFT.meta.attributes) {
		  var attrib = NFT.meta.attributes[idx];
		  Traits[attrib.trait_type] = attrib.value;
	      }
	      /* ------ Fetch Planet Stats ---------------- */
	      {
		  const Planet = Moralis.Object.extend("Planet");
		  const query = new Moralis.Query(Planet);
		  query.equalTo("identity", Traits.galactic_catalog);
		  const results = await query.first();
		  results.fetch();
		  // console.log("Planet:", results);
		  var pd = results.attributes;
		  const nameMap = [
		      ["evaluation", "Primary Evaluation"],
		      ["evaluation2", "Secondary Evaluation"],
		      ["identity", "Galactic Catalog Id"],
		      ["star_system", "Star System"],
		      ["star_index", "Star Index"],
		      ["planet_index", "Planet Index"],
		      ["planet_type", "Planet Type"],
		      ["atmosphere_composition", "Atmosphere"],
		      ["lifeform", "Lifeform"],
		      ["chemistry", "Life Chemistry"],
		      ["rare", "Rare Minerals"],
		      ["radioactives", "Radioactive Minerals"],
		      ["refractories", "High Temperature Minerals"],
		      ["industrials", "Industrial Minerals"],
		      ["specialized", "Specialized Minerals"],
		      ["biologicals", "Biological Resources"],
		      ["exotics", "Minerals Unique to Planet"],
		      ["relics", "Relics from Antiquity"],
		      ["resources_value", "Total Resource Value"],
		  ];
		  var official = document.getElementById("official");
		  official.innerText = `${pd['star_index']} ${pd['star_system']} ${fromRoman(pd['planet_index'])}`;
		  var html = `<table class="statstable">\n`;
		  html += `<tr><td>Official Designation</td><td>${pd['star_index']} ${pd['star_system']} ${pd['planet_index']}</td></tr>\n`;
		  for (idx in nameMap) {
		      const entry = nameMap[idx];
		      const lookup = entry[0];
		      const name = entry[1];
		      var value = new String(pd[lookup]).replaceAll("_", " ");
		      html += `<tr name="${lookup}"><td name="${lookup}">${name}</td><td id="${lookup}">${value}</td></tr>\n`;
		  }
		  html += "</table>";
		  var info = document.getElementById("basestatstable");
		  info.innerHTML = html;
	      }
	      /* ------ Fetch Civilization Info ---------------- */
	      {
		  const Civ = Moralis.Object.extend("Civilization");
		  const query = new Moralis.Query(Civ);
		  query.equalTo("identity", Traits.galactic_catalog);
		  query.include("events");
		  const results = await query.first();
		  // console.log("Civ:", JSON.stringify(results));
		  NFT.Civ = results;
		  var pd = results.attributes;
		  const nameMap = [
		      ["identity", "Galactic Catalog Id"],
		      ["name", "Name", "input", 40],
		      ["motto", "Motto", "input", 200],
		      ["updatedAt","updatedAt", 16],
		      ["species", "Species", "input", 40],
		      ["culture", "Culture Type"],
		      ["population", "Population"],
		      ["tritanium44", "Tritanium-44 Reserves"],
		      ["generation", "Prior Lost Civilizations"],

		      // tech levels
		      ["bio", "Biological", "number"],
		      ["energy", "Energy", "number"],
		      ["information", "Information", "number"],
		      ["engineering", "Engineering", "number"],
		      ["science", "Science", "number"],
		      ["transport", "Transporation", "number"],
		      ["social", "Social", "number"],
		      ["warfare", "Warfare", "number"],
		      ["economic", "Economics", "number"],
		      ["spiritual", "Spiritual", "number"],
		      ["art", "Art", "number"],

		      // artificial assets
		      ["knowledge", "Accumulated Knowledge"],
		      ["infrastructure", "Infrastructure"],
		      ["manufactured", "Manufactured Goods"],
		      ["services", "Services"],
		      ["entertainment", "Entertainment"],
		      ["woo", "Woo"]
		  ];

		  var common = document.getElementById("common");
		  common.innerText = pd['name'];

		  var headname = document.getElementById("headname");
		  headname.innerText = `${currentNFT} - ${pd['name']}`;

		  var motto = document.getElementById("motto");
		  motto.innerText = `"${pd['motto']}"`;

		  var identity1 = document.getElementById("identity1");
		  identity1.innerText = pd['identity'];

		  updatedAt.innerText = pd['updatedAt'];

		  let techs = ['bio', 'energy', 'information', 'engineering', 'science', 'transport',
			       'social', 'warfare', 'economic', 'spiritual', 'art'];
		  var totalLevel = 0;
		  techs.forEach(function (tech) {
		      let level = results.get(tech);
		      totalLevel += level;
		  });
		  planetLevel.innerText = Math.round(totalLevel * 10 / techs.length) / 10;

		  var html = `<table class="statstable">\n`;
		  for (idx in nameMap) {
		      const entry = nameMap[idx];
		      const lookup = entry[0];
		      const name = entry[1];
		      const itype = entry[2];
		      const maxlength = entry[3];
		      const id = `civ${name}`;
		      const value = new String(pd[lookup]).replaceAll("_", " ");
		      if (itype) {
			  if (itype == "text") {
			      html += `<tr name="${lookup}"><td name="${lookup}">${name}</td><td id="${lookup}">${value}<td></tr>\n`;
			  } else if (itype == "input") {
			      html += `<tr name="${lookup}">
									  <td name="${lookup}" colspan="2">${name}  <input style="font-size: 2vw; width: 60%;" name="${lookup}" id="${id}" value="${value}" maxlength="{maxlength}">
										<button onclick="Move('Civilization', '${Traits.galactic_catalog}', '${lookup}', 'setvalue', {'field':'${lookup}','value':${id}.value})">Set</button>
										</td>
										</tr>\n`;
			  } else if (itype == "number") {
			      html += `<tr name="${lookup}"><td name="${lookup}">${name}</td><td id="${lookup}">${value}</td></tr>\n`;
			  }
		      }
		      else {
			  html += `<tr name="${lookup}"><td name="${lookup}">${name}</td><td id="${lookup}">${value}</td></tr>\n`;
		      }
		  }
		  html += "</table>";
		  var info = document.getElementById("civstatstable");
		  info.innerHTML = html;
	      }
	      var population = document.getElementById("population");
	      var t44production = document.getElementById("t44production");

	      getEvents(NFT);
	  }

	  var lastEventsCount = {};

	  async function getEvents(NFT) {
	      var planetevents = document.getElementById("eventlist");
	      let eventlistholder = document.getElementById("eventlistholder");1
	      if (eventlistholder)
		  planetevents.removeChild(eventlistholder);
	      eventlistholder = document.createElement("div");
	      eventlistholder.id = "eventlistholder";
	      planetevents.appendChild(eventlistholder);
	      
	      let civ = await NFT.Civ;
	      let events = null;
	      try {
		  events = civ.get('events');
	      } catch (ex) {
		  console.log(ex);
		  return;
	      }

	      if (events == null || events.length == 0)
		  return;
	      
	      let html = "";
	      for (var idx in events) {
		  const event = events[idx];
		  await event.fetch();
		  const identity = event.get("identity");
		  if (!identity) {
		      //console.log(`New Event Identity Missing: ${JSON.stringify(event, null, 4)}`);
		      continue;
		  }
		  //console.log(`New Event: ${idx}>=${lastEventsCount} ${JSON.stringify(event, null, 4)}`);
		  const imageUrl = event.get('image_url');
		  const videoUrl = event.get('video_url');
		  const color = event.get('color') || 'black';
		  //child.style.color = event['color'];
		  const apparent = event.get('apparent');
		  const date = new Date();
		  const affected = event.get('affected');
		  const cost = parseFloat(event.get('cost'));
		  const influence = event.get('influence');
		  let effects = effectsString(affected);

		  html = `<div name="planetevent" style="border-radius: 1vw; margin: 0 auto; background-image: url('${imageUrl}'); background-size: cover;" onmousedown="this.style.backgroundImage = ''">
									<div><p " style="color: white; text-align: center; text-shadow: 20px 0 20px ${color}, 0 20px 20px ${color}, -20px 0 20px ${color}, 0 -20px 20px ${color};">
									${date.getYear() + 1900}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}<br/><br/>
										${event.get('apparent')}<br/><br/>Possible effects<br>${effects}
										<br><i>${influence}<i></br>
											</div>
										</div>
										<div style="text-align: center; color: inherit; margin: 0 auto;">
									<span style="width: 100%; margin: 0% auto;">0 <input style="width: 60%;" type="range" id="spend${idx}" min="0" max="100" value="0" oninput="rangeValue${idx}.innerText = dimReturn(this.value, ${cost})"> 100%</span>
										</div>
										<div>
												<div style="text-align: center;" id="rangeValue${idx}"></div></td>
												<div style="text-align: center;"><button name="influence" onclick="Move('Event', '${event.id}', '${identity}', 'influence', {'spend':spend${idx}.value}, 'rangeValue${idx}' )">Influence</button></div>
									<hr>
										</div>` + html; // (Put new stuff at the top)
	      }
	      eventlistholder.innerHTML = html;
	  }

	  var ChainMap = {
	      "80001": "mumbai",
	      "Mumbai": "mumbai"
	  }

	  function mapChain(chain) {
	      let mapped = ChainMap[chain];
	      if (mapped)
		  return mapped;
	      return chain
	  }

	  async function getArbitraryNFT(chain, contract, tokenid) {
	      if (contract.slice(0, 2) != "0x")
		  contract = "0x" + contract;
	      chain = mapChain(chain);
	      const options = {
		  chain: chain,
		  address: contract,
		  token_id: tokenid
	      };
	      const nft = await Moralis.Web3API.token.getTokenIdMetadata(options);
	      if (nft)
		  console.log(`Arbitrary NFT: ${JSON.stringify(nft, null, 4)}`);
	      return nft;
	  }

	  async function loadFirstNFT() {
	      try {
		  let nft = await getArbitraryNFT(Params.chain, Params.contract, Params.tokenid);
		  if (nft) {
		      userNFTs.unshift(nft); // push NFT into position 0, first NFT
		      currentNFT++;
		  }
	      }
	      catch (ex) {
		  console.error(`error fetching NFT ${ex}`);
	      }
	  }

	  LoadNFTarray(userNFTs).then((nfts) => Update(nfts[0])).catch(console.log);

	</script>
      </div>
  </body>
</head>
